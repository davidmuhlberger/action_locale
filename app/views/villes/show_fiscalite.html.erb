<% content_for :head do %>
  <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {packages: ['corechart', 'bar'], 'language': 'fr'});
      google.charts.setOnLoadCallback(drawImpots);

      function drawImpots() {
        var data = google.visualization.arrayToDataTable([
          ['', 'Taxe foncière / habitant <%=escape_javascript @ville[:nom].downcase.capitalize %>', "Taxe d'habitation / habitant <%=escape_javascript @ville[:nom].downcase.capitalize %>", 'Taxe foncière / habitant moyenne', "Taxe d'habitation / habitant moyenne"],
          ["2008", <%= @comptes_2008[:recette_taxe_fonciere_bati] / @comptes_2008[:population] %>, <%= @comptes_2008[:recette_taxe_habitation] / @comptes_2008[:population] %>, <%= @comptes_moy_2008[:recette_taxe_fonciere_bati] / @comptes_moy_2008[:population] %>, <%= @comptes_moy_2008[:recette_taxe_habitation] / @comptes_moy_2008[:population] %>],
          ["2009", <%= @comptes_2009[:recette_taxe_fonciere_bati] / @comptes_2009[:population] %>, <%= @comptes_2009[:recette_taxe_habitation] / @comptes_2009[:population] %>, <%= @comptes_moy_2009[:recette_taxe_fonciere_bati] / @comptes_moy_2009[:population] %>, <%= @comptes_moy_2009[:recette_taxe_habitation] / @comptes_moy_2009[:population] %>],
          ["2010", <%= @comptes_2010[:recette_taxe_fonciere_bati] / @comptes_2010[:population] %>, <%= @comptes_2010[:recette_taxe_habitation] / @comptes_2010[:population] %>, <%= @comptes_moy_2010[:recette_taxe_fonciere_bati] / @comptes_moy_2010[:population] %>, <%= @comptes_moy_2010[:recette_taxe_habitation] / @comptes_moy_2010[:population] %>],
          ["2011", <%= @comptes_2011[:recette_taxe_fonciere_bati] / @comptes_2011[:population] %>, <%= @comptes_2011[:recette_taxe_habitation] / @comptes_2011[:population] %>, <%= @comptes_moy_2011[:recette_taxe_fonciere_bati] / @comptes_moy_2011[:population] %>, <%= @comptes_moy_2011[:recette_taxe_habitation] / @comptes_moy_2011[:population] %>],
          ["2012", <%= @comptes_2012[:recette_taxe_fonciere_bati] / @comptes_2012[:population] %>, <%= @comptes_2012[:recette_taxe_habitation] / @comptes_2012[:population] %>, <%= @comptes_moy_2012[:recette_taxe_fonciere_bati] / @comptes_moy_2012[:population] %>, <%= @comptes_moy_2012[:recette_taxe_habitation] / @comptes_moy_2012[:population] %>],
          ["2013", <%= @comptes_2013[:recette_taxe_fonciere_bati] / @comptes_2013[:population] %>, <%= @comptes_2013[:recette_taxe_habitation] / @comptes_2013[:population] %>, <%= @comptes_moy_2013[:recette_taxe_fonciere_bati] / @comptes_moy_2013[:population] %>, <%= @comptes_moy_2013[:recette_taxe_habitation] / @comptes_moy_2013[:population] %>],
          ["2014", <%= @comptes_2014[:recette_taxe_fonciere_bati] / @comptes_2014[:population] %>, <%= @comptes_2014[:recette_taxe_habitation] / @comptes_2014[:population] %>, <%= @comptes_moy_2014[:recette_taxe_fonciere_bati] / @comptes_moy_2014[:population] %>, <%= @comptes_moy_2014[:recette_taxe_habitation] / @comptes_moy_2014[:population] %>],
          ["2015", <%= @comptes_2015[:recette_taxe_fonciere_bati] / @comptes_2015[:population] %>, <%= @comptes_2015[:recette_taxe_habitation] / @comptes_2015[:population] %>, <%= @comptes_moy_2015[:recette_taxe_fonciere_bati] / @comptes_moy_2015[:population] %>, <%= @comptes_moy_2015[:recette_taxe_habitation] / @comptes_moy_2015[:population] %>]
        ]);

        var options = {
          'width' : 750,
          'height' : 350,
          'chartArea' : {
            'width': 400,
            'height': 250
          },
          colors: ['#2196F3','#B0BEC5'],
          'legend' : {
            'alignment': 'center'
          },
          'isStacked': true,
          vAxis: {
            viewWindow: {
              max: 1100,
              min: 0
            }
          },
          vAxes: {
            1: {
              gridlines: {
                color: 'transparent'
              },
              textStyle: {
                color: 'transparent'
              }
            },
          },
          series: {
            2: {
              targetAxisIndex: 1
            },
            3: {
              targetAxisIndex: 1
            },
          },
        };

        var impotschart = new google.charts.Bar(document.getElementById('impots_chart_div'));
        impotschart.draw(data, google.charts.Bar.convertOptions(options));
      }
    </script>
<% end %>


<div class="container">
  <div class="row">
    <div class="col-md-2 col-sm-12">
    </div>
    <div class="col-md-10 col-sm-12">
      <div class="entity-title">
        <h1>
          <%= @ville[:nom].downcase.capitalize %>
        </h1>
      </div>
      <br>
      <ul class="nav nav-tabs">
        <li role="presentation">
          <%= link_to "Indicateurs", ville_indicateurs_path(nom: @ville.nom) %>
        </li>
        <li role="presentation" class="active">
          <%= link_to "Fiscalité", ville_fiscalite_path(nom: @ville.nom) %>
        </li>
        <li role="presentation">
          <%= link_to "Dépenses", ville_depenses_path(nom: @ville.nom) %>
        </li>
        <li role="presentation">
          <%= link_to "Finances", ville_finances_path(nom: @ville.nom) %>
        </li>
      </ul>
      <br>
      <div class="card">
        <div class="card-title">
          <br>
          <h4><strong>Historique - Impôts locaux</strong></h4>
          <br>
          <p>
            Ce graphique présente l'évolution des deux principaux impôts locaux,
            c'est-à-dire la taxe d'habitation et la taxe foncière, entre les années 2008 et 2015,
            et la compare, sur la même période, à l'évolution de ces impôts en moyenne pour
            l'ensemble des communes de taille comparable en France.
            <br>
            <br>
            <div class="card-tab">
              <div id="impots_chart_div"></div>
            </div>
            A titre d'exemple, la taxe foncière par habitant pour l'année 2015
            correspond au montant de taxe foncière qui est payé en moyenne par un habitant
            de la commune. La taxe foncière est payée par chaque foyer. Le montant moyen par
            foyer en 2015 était de <%= @comptes_2015[:recette_taxe_fonciere_bati]/@ville[:nb_menages_2013] %>€
            et la taxe d'habitation de <%= @comptes_2015[:recette_taxe_habitation]/@ville[:nb_menages_2013] %>€.
            <br>
            <br>
            Pour plus d'informations sur la nature de chacune de ses taxes,
            vous pouvez consulter la section impôts et taxes du <%= link_to "lexique", pages_lexique_path %>.
            <br>
            <br>
            La taxe foncière par habitant a augmenté de <%= number_to_percentage(100*(@comptes_2015[:recette_taxe_fonciere_bati]/@comptes_2015[:population])/(@comptes_2008[:recette_taxe_fonciere_bati]/@comptes_2008[:population]) - 100, precision: 0) %>
            entre 2008 et 2015 et atteint <%= @comptes_2015[:recette_taxe_fonciere_bati]/@comptes_2015[:population] %>€ a la fin de l'année 2015.
            <br>
            Pendant la même période, les communes françaises de même taille ont augmenté le montant de la taxe foncière par habitant de <%= number_to_percentage(100*(@comptes_moy_2015[:recette_taxe_fonciere_bati]/@comptes_moy_2015[:population])/(@comptes_moy_2008[:recette_taxe_fonciere_bati]/@comptes_moy_2008[:population]) - 100, precision: 0) %>,
            à <%= @comptes_moy_2015[:recette_taxe_fonciere_bati]/@comptes_moy_2015[:population] %>€.
            <br>
            <br>
            La taxe d'habitation  a augmenté de <%= number_to_percentage(100*(@comptes_2015[:recette_taxe_habitation]/@comptes_2015[:population])/(@comptes_2008[:recette_taxe_habitation]/@comptes_2008[:population]) - 100, precision: 0) %>
            entre 2008 et 2015 et atteint <%= @comptes_2015[:recette_taxe_habitation]/@comptes_2015[:population] %>€ a la fin de l'année 2015.
            <br>
            Pendant la même période, les communes françaises de même taille ont augmenté le montant de la taxe d'habitation de <%= number_to_percentage(100*(@comptes_moy_2015[:recette_taxe_habitation]/@comptes_moy_2015[:population])/(@comptes_moy_2008[:recette_taxe_habitation]/@comptes_moy_2008[:population]) - 100, precision: 0) %>,
            à <%= @comptes_moy_2015[:recette_taxe_habitation]/@comptes_moy_2015[:population] %>€ par habitant.
            <br>
            <br>
            <br>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
