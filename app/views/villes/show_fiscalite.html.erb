<% content_for :head do %>
  <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      google.charts.load('current', {packages: ['corechart', 'bar'], 'language': 'fr'});
      google.charts.setOnLoadCallback(drawth);
      google.charts.setOnLoadCallback(drawtf);
      google.charts.setOnLoadCallback(drawautres);
      function drawth() {
        var data = google.visualization.arrayToDataTable([
          ['', "Taxe d'habitation part commune ", "Taxe d'habitation part groupement ", "Taxe d'habitation part commune moyenne ", "Taxe d'habitation part groupement moyenne "],
          ["2011", <%= @comptes_2011[:th_produit_commune] / @comptes_2011[:population] %>, <%= (@comptes_2011[:th_produit_epci]+@comptes_2011[:th_produit_syndicat]) / @comptes_2011[:population] %>, <%= @comptes_moy_2011[:th_produit_commune] / @comptes_moy_2011[:population] %>, <%= (@comptes_moy_2011[:th_produit_epci]+@comptes_moy_2011[:th_produit_syndicat]) / @comptes_moy_2011[:population] %>],
          ["2012", <%= @comptes_2012[:th_produit_commune] / @comptes_2012[:population] %>, <%= (@comptes_2012[:th_produit_epci]+@comptes_2012[:th_produit_syndicat]) / @comptes_2012[:population] %>, <%= @comptes_moy_2012[:th_produit_commune] / @comptes_moy_2012[:population] %>, <%= (@comptes_moy_2012[:th_produit_epci]+@comptes_moy_2012[:th_produit_syndicat]) / @comptes_moy_2012[:population] %>],
          ["2013", <%= @comptes_2013[:th_produit_commune] / @comptes_2013[:population] %>, <%= (@comptes_2013[:th_produit_epci]+@comptes_2013[:th_produit_syndicat]) / @comptes_2013[:population] %>, <%= @comptes_moy_2013[:th_produit_commune] / @comptes_moy_2013[:population] %>, <%= (@comptes_moy_2013[:th_produit_epci]+@comptes_moy_2013[:th_produit_syndicat]) / @comptes_moy_2013[:population] %>],
          ["2014", <%= @comptes_2014[:th_produit_commune] / @comptes_2014[:population] %>, <%= (@comptes_2014[:th_produit_epci]+@comptes_2014[:th_produit_syndicat]) / @comptes_2014[:population] %>, <%= @comptes_moy_2014[:th_produit_commune] / @comptes_moy_2014[:population] %>, <%= (@comptes_moy_2014[:th_produit_epci]+@comptes_moy_2014[:th_produit_syndicat]) / @comptes_moy_2014[:population] %>],
          ["2015", <%= @comptes_2015[:th_produit_commune] / @comptes_2015[:population] %>, <%= (@comptes_2015[:th_produit_epci]+@comptes_2015[:th_produit_syndicat]) / @comptes_2015[:population] %>, <%= @comptes_moy_2015[:th_produit_commune] / @comptes_moy_2015[:population] %>, <%= (@comptes_moy_2015[:th_produit_epci]+@comptes_moy_2015[:th_produit_syndicat]) / @comptes_moy_2015[:population] %>],
          ["2016", <%= @comptes_2016[:th_produit_commune] / @comptes_2016[:population] %>, <%= (@comptes_2016[:th_produit_epci]+@comptes_2016[:th_produit_syndicat]) / @comptes_2016[:population] %>, <%= @comptes_moy_2016[:th_produit_commune] / @comptes_moy_2016[:population] %>, <%= (@comptes_moy_2016[:th_produit_epci]+@comptes_moy_2016[:th_produit_syndicat]) / @comptes_moy_2016[:population] %>]
        ]);
        var options = {
          'width' : 750,
          'height' : 350,
          'chartArea' : {
            'width': 400,
            'height': 250
          },
          colors: ['#2196F3','#B0BEC5'],
          'legend' : {
            'alignment': 'center'
          },
          'isStacked': true,
          vAxes: {
            1: {
              gridlines: {
                color: 'transparent'
              },
              textStyle: {
                color: 'transparent'
              }
            },
          },
          series: {
            2: {
              targetAxisIndex: 1
            },
            3: {
              targetAxisIndex: 1
            },
          },
        };
        var thchart = new google.charts.Bar(document.getElementById('th_chart_div'));
        thchart.draw(data, google.charts.Bar.convertOptions(options));
      };

      function drawtf() {
        var data = google.visualization.arrayToDataTable([
          ['', "Taxe d'habitation part commune", "Taxe d'habitation part groupement", "Taxe d'habitation part commune moyenne", "Taxe d'habitation part groupement moyenne"],
          ["2011", <%= @comptes_2011[:tfb_produit_commune] / @comptes_2011[:population] %>, <%= (@comptes_2011[:tfb_produit_epci]+@comptes_2011[:tfb_produit_syndicat]) / @comptes_2011[:population] %>, <%= @comptes_moy_2011[:tfb_produit_commune] / @comptes_moy_2011[:population] %>, <%= (@comptes_moy_2011[:tfb_produit_epci]+@comptes_moy_2011[:tfb_produit_syndicat]) / @comptes_moy_2011[:population] %>],
          ["2012", <%= @comptes_2012[:tfb_produit_commune] / @comptes_2012[:population] %>, <%= (@comptes_2012[:tfb_produit_epci]+@comptes_2012[:tfb_produit_syndicat]) / @comptes_2012[:population] %>, <%= @comptes_moy_2012[:tfb_produit_commune] / @comptes_moy_2012[:population] %>, <%= (@comptes_moy_2012[:tfb_produit_epci]+@comptes_moy_2012[:tfb_produit_syndicat]) / @comptes_moy_2012[:population] %>],
          ["2013", <%= @comptes_2013[:tfb_produit_commune] / @comptes_2013[:population] %>, <%= (@comptes_2013[:tfb_produit_epci]+@comptes_2013[:tfb_produit_syndicat]) / @comptes_2013[:population] %>, <%= @comptes_moy_2013[:tfb_produit_commune] / @comptes_moy_2013[:population] %>, <%= (@comptes_moy_2013[:tfb_produit_epci]+@comptes_moy_2013[:tfb_produit_syndicat]) / @comptes_moy_2013[:population] %>],
          ["2014", <%= @comptes_2014[:tfb_produit_commune] / @comptes_2014[:population] %>, <%= (@comptes_2014[:tfb_produit_epci]+@comptes_2014[:tfb_produit_syndicat]) / @comptes_2014[:population] %>, <%= @comptes_moy_2014[:tfb_produit_commune] / @comptes_moy_2014[:population] %>, <%= (@comptes_moy_2014[:tfb_produit_epci]+@comptes_moy_2014[:tfb_produit_syndicat]) / @comptes_moy_2014[:population] %>],
          ["2015", <%= @comptes_2015[:tfb_produit_commune] / @comptes_2015[:population] %>, <%= (@comptes_2015[:tfb_produit_epci]+@comptes_2015[:tfb_produit_syndicat]) / @comptes_2015[:population] %>, <%= @comptes_moy_2015[:tfb_produit_commune] / @comptes_moy_2015[:population] %>, <%= (@comptes_moy_2015[:tfb_produit_epci]+@comptes_moy_2015[:tfb_produit_syndicat]) / @comptes_moy_2015[:population] %>],
          ["2016", <%= @comptes_2016[:tfb_produit_commune] / @comptes_2016[:population] %>, <%= (@comptes_2016[:tfb_produit_epci]+@comptes_2016[:tfb_produit_syndicat]) / @comptes_2016[:population] %>, <%= @comptes_moy_2016[:tfb_produit_commune] / @comptes_moy_2016[:population] %>, <%= (@comptes_moy_2016[:tfb_produit_epci]+@comptes_moy_2016[:tfb_produit_syndicat]) / @comptes_moy_2016[:population] %>]
        ]);
        var options = {
          'width' : 750,
          'height' : 350,
          'chartArea' : {
            'width': 400,
            'height': 250
          },
          colors: ['#2196F3','#B0BEC5'],
          'legend' : {
            'alignment': 'center'
          },
          'isStacked': true,
          vAxes: {
            1: {
              gridlines: {
                color: 'transparent'
              },
              textStyle: {
                color: 'transparent'
              }
            },
          },
          series: {
            2: {
              targetAxisIndex: 1
            },
            3: {
              targetAxisIndex: 1
            },
          },
        };
        var tfchart = new google.charts.Bar(document.getElementById('tf_chart_div'));
        tfchart.draw(data, google.charts.Bar.convertOptions(options));
      };
      function drawautres() {
        var data = google.visualization.arrayToDataTable([
          ['', "Autres taxes commune", "Autres taxes moyenne"],
          ["2011", <%= @comptes_2011[:autres_impots_taxes_7] / @comptes_2011[:population] %>, <%= @comptes_moy_2011[:autres_impots_taxes_7] / @comptes_moy_2011[:population] %>],
          ["2012", <%= @comptes_2012[:autres_impots_taxes_7] / @comptes_2012[:population] %>, <%= @comptes_moy_2012[:autres_impots_taxes_7] / @comptes_moy_2012[:population] %>],
          ["2013", <%= @comptes_2013[:autres_impots_taxes_7] / @comptes_2013[:population] %>, <%= @comptes_moy_2013[:autres_impots_taxes_7] / @comptes_moy_2013[:population] %>],
          ["2014", <%= @comptes_2014[:autres_impots_taxes_7] / @comptes_2014[:population] %>, <%= @comptes_moy_2014[:autres_impots_taxes_7] / @comptes_moy_2014[:population] %>],
          ["2015", <%= @comptes_2015[:autres_impots_taxes_7] / @comptes_2015[:population] %>, <%= @comptes_moy_2015[:autres_impots_taxes_7] / @comptes_moy_2015[:population] %>],
          ["2016", <%= @comptes_2016[:autres_impots_taxes_7] / @comptes_2016[:population] %>, <%= @comptes_moy_2016[:autres_impots_taxes_7] / @comptes_moy_2016[:population] %>],
        ]);

        var options = {
          'width' : 750,
          'height' : 350,
          'chartArea' : {
            'width': 400,
            'height': 200
          },
          colors: ['#2196F3','#B0BEC5'],
          'legend' : {
            'alignment': 'center'
          },
        };

        var autreschart = new google.charts.Bar(document.getElementById('autres_chart_div'));
        autreschart.draw(data, google.charts.Bar.convertOptions(options));
      }
    </script>
<% end %>


<div class="container">
  <div class="row">
    <div class="col-md-2 col-sm-12">
    </div>
    <div class="col-md-10 col-sm-12">
      <br>
      <div class="entity-title">
        <h2>
          <strong><%= @ville[:nom_propre].mb_chars.upcase%></strong>
        </h2>
      </div>
      <div class="text-center">
        <%= image_tag "town_illustration.png" %>
      </div>
      <br>
      <ul class="nav nav-tabs">
        <li role="presentation">
          <%= link_to "Chiffres clés", ville_indicateurs_path(nom: @ville.nom) %>
        </li>
        <li role="presentation" class="active">
          <%= link_to "Fiscalité", ville_fiscalite_path(nom: @ville.nom) %>
        </li>
        <li role="presentation">
          <%= link_to "Dépenses", ville_depenses_path(nom: @ville.nom) %>
        </li>
        <li role="presentation">
          <%= link_to "Finances", ville_finances_path(nom: @ville.nom) %>
        </li>
      </ul>
      <br>
      <div class="card">
        <div class="card-title">
          <br>
          <h4><strong>Historique - Impôts locaux</strong></h4>
          <br>
          <p>
            Le niveau d’imposition est à mettre en regard de la richesse de la population et du niveau de dépenses.
            Il sera plus facile pour une ville dont la population est aisée de pratiquer des niveaux d’imposition élevés,
            et de proposer à ses habitants de nombreux services, à la hauteur de leur contribution.
          </p>
          <br>
          <p>
            Ces graphiques présentent l'évolution des deux principaux impôts locaux,
            c'est-à-dire la taxe d'habitation et la taxe foncière, entre les années 2011 et 2016,
            et la compare, sur la même période, à l'évolution de ces impôts en moyenne pour
            l'ensemble des communes de taille comparable en France.
            <br>
            <br>
            Nous prenons en compte la part de ces impôts qui est prélevée par la commune et celle qui est prélevée par le
            groupement de communes dont elle fait éventuellement partie.
            En effet, les communes mutualisent de plus en plus de services entre elles,
            avec un niveau plus ou moins élevé d’intégration. Les comparaisons doivent donc se faire en
            considérant la somme de la fiscalité prélevée par la commune et par son groupement,
            pour bien prendre en compte les mêmes compétences.
            <br>
            <br>
            Le détail des impôts et taxes applicables dans une commune sont disponible dans notre
            notice traitant de la <%= link_to "fiscalité locale", pages_notice_fiscalite_path %>.
            <br>
            <br>
            <% if @comptes_2016[:th_produit_epci]+@comptes_2016[:th_produit_syndicat]+@comptes_2016[:tfb_produit_epci]+@comptes_2016[:tfb_produit_syndicat]  == 0 %>
              <p>
              <br>
              <br>
              <%= @ville[:nom_propre] %> ne fait pas partie d'un groupement de communes qui impose ses habitants. Le niveau
              de fiscalité par habitant doit néanmoins être comparé à la fiscalité moyenne des commune et des
              groupements pour les villes de taille comparable.
              </p>
            <% end %>
            <% if @ville[:nb_res_secondaires] / @comptes_2016[:population] >= 0.5 %>
              <p>
              <br>
              <br>
              Attention. Il y a dans cette commune une part importante de résidences secondaires :
              <%= @ville[:nb_res_secondaires] %> résidences secondaires pour une population de <%= @comptes_2016[:population] %> habitants.
              Les données fiscales et financières par habitant peuvent donc sembler artificiellement élevées.
              </p>
            <% end %>
            <% if @ville[:metropole] == "MGP" %>
            <br>
              <p>
                <strong>Attention, depuis 2016, <%= @ville[:nom_propre] %> reçoit la taxe d'habitation auparavant prélevée par son groupement de commune et la reverse à la Métropole du Grand Paris, son nouveau groupement.</strong>
              </p>
            <br>
            <% end %>
            <div class="card-tab">
            <h4><strong>Taxe d'habitation (€ par habitant)</strong></h4>
              <div id="th_chart_div"></div>
            </div>
            <% if @ville[:metropole] == "MGL" %>
            <br>
              <p>
                <strong>Attention, depuis 2015, la Métropole du Grand Lyon prélève la part départementale de la taxe d'habitation à <%= @ville[:nom_propre] %></strong>
              </p>
            <br>
            <% end %>
            <div class="card-tab">
            <h4><strong>Taxe foncière (€ par habitant)</strong></h4>
              <div id="tf_chart_div"></div>
            </div>
            <br>
            <p>
              D’autres impôts et taxes sont collectés par la commune, principalement la taxe d’enlèvement des ordures ménagères,
              la taxe sur la publicité extérieure, les droits de stationnement, les droits funéraires, etc.
            </p>
            <div class="card-tab">
            <h4><strong>Autres impôts et taxes (€ par habitant)</strong></h4>
              <div id="autres_chart_div"></div>
            </div>
            <br>
            <br>
          </p>
          <p class="text-center">
          <%= image_tag "end_text_symbol.png" %>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Button trigger modal -->


<!-- Modal TH -->
<div class="modal fade" id="modalTh" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"><strong>La taxe d'habitation</strong></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <p>
        La taxe d'habitation est due par le foyer occupant d'un logement.
        Elle est prélevée par la commune et l'intercommunalité.
        <br>
        <br>
        Elle est calculée à partir des bases cadastrales qui sont des estimations des revenus locatifs
        que génère ou pourrait générer un bien. Des taux votés par la commune et l'intercommunalité sont
        ensuite appliqués à cette base.
        <br>
        Les foyers avec de faibles revenus sont totalement ou partiellement exonérés de taxe d'habitation.
        <br>
        <br>
        La taxe d'habitation finance donc le budget de fonctionnement des communes et collectivités (achats, personnel, entretien).
        L'année dernière elle a rapporté 16,5 Md€ aux collectivités.
      </p>
      </div>
      <div class="modal-footer">
        <p>
        Source : Les Collectivités locales en chiffres, DGCL, 2017
        </p>
      </div>
    </div>
  </div>
</div>
<!-- Modal TF -->
<div class="modal fade" id="modalTf" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel"><strong>Les taxes foncières</strong></h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
      <p>
        Il existe une taxe foncière sur le foncier bâti (immeubles, maisons, appartements, bureaux...)
        et une taxe foncière sur le foncier non bâti (terrains nus)
        <br>
        <br>
        La taxe foncière est dûe par le propriétaire d'un bien immobilier.
        <br>
        <br>
        Elle est calculée à partir des bases cadastrales qui sont des estimations des revenus locatifs
        que génère ou pourrait générer un bien. Des taux voté par la commune, l'intercommunalité et le département sont
        ensuite appliqués à cette base.
        <br>
        Les foyers avec de faibles revenus ou âgés peuvent bénéficier d'un abattement.
        <br>
        <br>
        La taxe sur le foncier bâti a rapporté 31,9 Md€ en 2016, et la taxe sur le foncier non bâti 1 Md€. Leur produit
        finance pour un peu plus de la moitié les communes et intercommunalités et pour le reste les départements.
      </p>
      </div>
      <div class="modal-footer">
        <p>
        Source : Les Collectivités locales en chiffres, DGCL, 2017
        </p>
      </div>
    </div>
  </div>
</div>
